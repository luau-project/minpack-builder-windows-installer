# Minpack Builder Windows Installer

## Summary

The goal of this repository is to provide a Windows Installer (.msi) to the [MINPACK-1](https://www.netlib.org/minpack) binaries built by our [Minpack Builder](https://github.com/luau-project/minpack-builder) project.

> [!IMPORTANT]
> 
> This project is currently in alpha stage, but the generated files are able to build a working installer. However, beware that you might find bugs. An improved documentation is coming soon.

## Table of Contents

* [How](#how)
* [Development](#development)
    * [How to insert binaries for a compiler](#how-to-insert-binaries-for-a-compiler)
    * [How to generate the WiX Toolset project](#how-to-generate-the-wix-toolset-project)
    * [Building the MSI installer](#building-the-msi-installer)

## How

In order to create a MSI package (.msi) for the binaries, we use [CMake](https://cmake.org/) (&ge; 3.20) to configure the project to be consumed by the command line tools of the [WiX Toolset V5](https://wixtoolset.org/).

## Development

### How to insert binaries for a compiler

Most of the source files (.wxs, .wxi) for the ```WiX Toolset``` project are generated by ```cmake``` at the configuration step. To ease the process to add binaries built by different compilers to the MSI package, we use a json file (.json) to provide enough information to configure such binaries for the installation.

The json configuration file must hold the root element as a json array whose elements follow the format:

```json
[
    {
        "CompilerId": "GFortranUCRTSixFour",
        "CompilerName": "GFortran UCRT64 from MSYS2",
        "Version": "14.2.0",
        "HostArch": "x64"
    },
    .
    .
    .,
    {
        "CompilerId": "LLVMFlangNewMsvcLike",
        "CompilerName": "LLVM flang-new MSVC-like",
        "Version": "18.1.7",
        "HostArch": "x64"
    }
]
```

Each element of the array must provide an unique ```CompilerId``` field to identify the compiler. Moreover, other fields such as ```CompilerName```, ```Version``` and ```HostArch``` help to describe the compiler properties to the end user. For instance, the first array element above shows information for ```GFortran 14.2.0``` using the universal C runtime from MSYS2 project targeting 64-bit architecture, while the last element identifies the ```LLVM flang-new 18.1.7``` emiting MSVC ABI-compatible binaries targeting 64-bit arch.

### How to generate the WiX Toolset project

First, these are some of the required tools used by the project that need to be available on your command prompt (or terminal):

* cmake (&gt; 3.20)
* uuidgen (comes from Visual Studio installation -- or MSYS2 -- on Windows, but is also available on Linux)
* pandoc
* weasyprint

> [!IMPORTANT]
> 
> For each ```CompilerId``` entry in the configuration file above, you must also provide a parameter to tell where binaries are stored for that compiler. For instance, assuming the configuration file cited, ```-DGFortranUCRTSixFour_BINARIES_DIR=path/to/gfortran/binaries``` would tell the directory holding gfortran binaries built by ```Minpack Builder```. Moreover, directories holding the source code for both ```Minpack``` and  ```Minpack Builder``` are needed, respectively (```-DMINPACK_SOURCES=path/to/minpack/source-code``` and ```-DMINPACK_BUILDER_SOURCES=path/to/minpack-builder/source-code```). The version of ```Minpack Builder``` library is also needed (```-DMINPACK_BUILDER_VERSION=1.1.0```).

In the project directory, run

```bash
cmake -DPROJECT_SETTINGS=path/to/settings.json -DGFortranUCRTSixFour_BINARIES_DIR=path/to/gfortran/binaries -DLLVMFlangNewMsvcLike_BINARIES_DIR=path/to/llvm-flang-msvc-like/binaries -DMINPACK_SOURCES=path/to/minpack/source-code -DMINPACK_BUILDER_SOURCES=path/to/minpack-builder/source-code -DMINPACK_BUILDER_VERSION=1.1.0 -S . -B build
```

If the command succeed, the source files for the ```WiX Toolset``` project will be stored at ```build/wixtoolset-v5```.

### Building the MSI installer

> [!IMPORTANT]
> 
> For this step, you need the ```wix``` command line program on a Windows machine. Visit [https://wixtoolset.org/](https://wixtoolset.org/) for instructions on how to install it.

Assuming you got this far, you were able to generate the ```WiX Toolset``` project, and it is stored on the directory ```build/wixtoolset-v5```.

Then, using a command prompt on a Windows machine, you can now change directory to ```build/wixtoolset-v5``` and execute the file ```msi.bat```, which builds the MSI package.

```cmd
cd build\wixtoolset-v5 && msi.bat
``` 