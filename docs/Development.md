## Table of Contents

* [Description](#description)
* [How to insert binaries for a compiler](#how-to-insert-binaries-for-a-compiler)
* [How to generate the WiX Toolset project](#how-to-generate-the-wix-toolset-project)
* [Requirements to build the MSI installer](#requirements-to-build-the-msi-installer)
* [Building the MSI installer](#building-the-msi-installer)
* [Known limitations](#known-limitations)

## Description

In order to create a MSI package (.msi) for the binaries, we use [CMake](https://cmake.org/) (&ge; 3.20) to configure the project to be consumed by the command line tools of the [WiX Toolset V5](https://wixtoolset.org/).

## How to insert binaries for a compiler

Most of the source files (.wxs, .wxi) for the ```WiX Toolset``` project are generated by ```cmake``` at the configuration step. To ease the process to add binaries built by different compilers to the MSI package, we use a json file (.json) to provide enough information to configure such binaries for the installation.

The json configuration file must hold the root element as a json array whose elements follow the format:

```json
[
    {
        "CompilerId": "GFortranUCRTSixFour",
        "CompilerName": "GFortran UCRT64 from MSYS2",
        "Version": "14.2.0",
        "HostArch": "x86_64"
    },
    .
    .
    .
    ,
    {
        "CompilerId": "LLVMFlangNewMsvcLike",
        "CompilerName": "LLVM flang-new MSVC-like",
        "Version": "18.1.7",
        "HostArch": "x86_64"
    }
]
```

Each element of the array must provide an unique ```CompilerId``` field to identify the compiler. Moreover, other fields such as ```CompilerName```, ```Version``` and ```HostArch``` help to describe the compiler properties to the end user. For instance, the first array element above shows information for ```GFortran 14.2.0``` using the universal C runtime from MSYS2 project targeting Windows Intel/AMD 64-bit version, which runs natively on and compiles for Windows 64-bit, while the last element identifies the ```LLVM flang-new 18.1.7``` emiting MSVC ABI-compatible binaries.

## How to generate the WiX Toolset project

First, the following are all the required tools used by the project that need to be available on your command prompt (or terminal):

* [cmake](https://cmake.org/) (&ge; 3.20)
* uuidgen
    * Windows
        * Visual Studio installation
        * MSYS2 installation
            ```bash
            pacman -S util-linux
            ```
    * Linux
        * Debian-derived distributions
            ```bash
            sudo apt-get install uuid-runtime
            ```
* [pandoc](https://pandoc.org)
* [weasyprint](https://weasyprint.org/)

> [!IMPORTANT]
> 
> Required CMake parameters:
> * ```<<CompilerId>>_BINARIES_DIR```: For each ```CompilerId``` entry in the configuration file, you must provide a respective parameter pointing to the directory where binaries are stored for that compiler. For instance, assuming the configuration file cited
>     ```bash
>     -DGFortranUCRTSixFour_BINARIES_DIR=path/to/gfortran/binaries
>     ```
>     would tell the directory holding gfortran binaries built by Minpack Builder;
> * ```MINPACK_SOURCES```: Path to the directory containing Minpack source code (directory holding Fortran *.f files, and also the disclaimer);
> * ```MINPACK_BUILDER_SOURCES```: Path to the directory containing Minpack Builder source code (e.g.: the path on disk to the extracted directory of [https://github.com/luau-project/minpack-builder/archive/refs/tags/1.1.0.zip](https://github.com/luau-project/minpack-builder/archive/refs/tags/1.1.0.zip));
> * ```MINPACK_BUILDER_VERSION```: Version of Minpack Builder (e.g.: 1.1.0).

In the project directory containing [CMakeLists.txt](../CMakeLists.txt), run

```bash
cmake -DPROJECT_SETTINGS=path/to/settings.json -DGFortranUCRTSixFour_BINARIES_DIR=path/to/gfortran/binaries -DLLVMFlangNewMsvcLike_BINARIES_DIR=path/to/llvm-flang-msvc-like/binaries -DMINPACK_SOURCES=path/to/minpack/source-code -DMINPACK_BUILDER_SOURCES=path/to/minpack-builder/source-code -DMINPACK_BUILDER_VERSION=1.1.0 -S . -B build
```

If the command succeed, the source files for the ```WiX Toolset``` project will be stored at ```build/wixtoolset-v5```.

## Requirements to build the MSI installer

> [!TIP]
> 
> The previous steps can be run either on Linux or Windows. However, you are required to be on Windows to build the MSI installer.

> [!IMPORTANT]
> 
> Required tools:
> * ```dotnet``` command line program for .NET 6.0 or newer (visit [https://dotnet.microsoft.com](https://dotnet.microsoft.com) to install it);
> * ```wix``` command line program for the [WiX Toolset V5](https://wixtoolset.org/): once ```dotnet``` is installed, run
>     ```cmd
>     dotnet tool install --global wix --version 5.0.1
>     ```

Before building the project, if you never did it, install and add the WixToolset.UI extension to the global cache:

```cmd
wix extension add -g WixToolset.UI.wixext/5.0.1
```

> [!NOTE]
> 
> The addition of WixToolset.UI extension to the global cache only needs to be done once

## Building the MSI installer

Congratulations if you got this far, because:
* you were able to generate the ```WiX Toolset``` project, which is assumed to be stored at ```build/wixtoolset-v5```;
* you managed to meet the requirements to build the MSI installer;
* you are ready to build the MSI installer.

Then, using a command prompt on a Windows machine, you can now change directory to ```build/wixtoolset-v5``` and execute the file ```msi.bat```, which builds the MSI package.

```cmd
cd build\wixtoolset-v5 && msi.bat
```

## Known limitations

In the current stage, the MSI installer works fine using the graphical user interface provided by Programs and Features (also known as Add/Remove Programs).

> [!IMPORTANT]
>
> It is known to **NOT** behave correctly through quiet command line installs:
> 
> ```cmd
> C:\path\to\installer.msi /qn
> ```