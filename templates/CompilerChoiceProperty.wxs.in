<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">

    <!-- Load project definitions -->
    <?include MinpackBuilder.wxi?>

    <!-- This fragment implements a modified version -->
    <!-- of the remember property pattern -->
    <!-- for @compiler_id@ -->
    <Fragment>

        <!-- Define the property -->
        <Property Id="$(@compiler_id@ChoiceProperty)" Secure="yes" Value="$(@compiler_id@ChoicePropertyDefaultValue)">
            <RegistrySearch
                Id="regsearch_$(@compiler_id@ChoiceProperty)"
                Root="$(MinpackBuilderRegistryRoot)"
                Key="$(MinpackBuilderRegistryKey)"
                Name="$(ActiveCompilerChoicePropertyRegistryName)"
                Type="raw"/>
        </Property>
        
        <!-- Component to store the compiler choice on registry -->
        <Component Id="@compiler_id@ChoicePropertyRegistry" Guid="$(@compiler_id@ChoicePropertyRegistryGuid)">
            <RegistryKey
                ForceDeleteOnUninstall="yes"
                Root="$(MinpackBuilderRegistryRoot)"
                Key="$(MinpackBuilderRegistryKey)">
                <RegistryValue Type="string"
                    Name="$(ActiveCompilerChoicePropertyRegistryName)"
                    Value="$(@compiler_id@ChoicePropertyDefaultValue)"/>
            </RegistryKey>
        </Component>

        <!-- start of test -->
        <Component Id="@compiler_id@ListOfInstalledCompilersRegistry" Guid="$(@compiler_id@ListOfInstalledCompilersRegistryGuid)">
            <RegistryKey
                ForceDeleteOnUninstall="yes"
                Root="$(MinpackBuilderRegistryRoot)"
                Key="$(MinpackBuilderRegistryKey)">
                <RegistryValue Type="string"
                    Name="ListOfInstalledCompilers"
                    Value="$(ListOfInstalledCompilers)"/>
            </RegistryKey>
        </Component>
        <Component Id="@compiler_id@NumberOfInstalledCompilersRegistry" Guid="$(@compiler_id@NumberOfInstalledCompilersRegistryGuid)">
            <RegistryKey
                ForceDeleteOnUninstall="yes"
                Root="$(MinpackBuilderRegistryRoot)"
                Key="$(MinpackBuilderRegistryKey)">
                <RegistryValue Type="integer"
                    Name="NumberOfInstalledCompilers"
                    Value="$(NumberOfInstalledCompilers)"/>
            </RegistryKey>
        </Component>
        <Component Id="@compiler_id@NameRegistry" Guid="$(@compiler_id@NameRegistryGuid)">
            <RegistryKey
                ForceDeleteOnUninstall="yes"
                Root="$(MinpackBuilderRegistryRoot)"
                Key="$(MinpackBuilderRegistryKey)">
                <RegistryValue Type="string"
                    Name="$(ActiveCompilerChoicePropertyRegistryName)Name"
                    Value="$(@compiler_id@CompilerName)"/>
            </RegistryKey>
        </Component>
        <Component Id="@compiler_id@VersionRegistry" Guid="$(@compiler_id@VersionRegistryGuid)">
            <RegistryKey
                ForceDeleteOnUninstall="yes"
                Root="$(MinpackBuilderRegistryRoot)"
                Key="$(MinpackBuilderRegistryKey)">
                <RegistryValue Type="string"
                    Name="$(ActiveCompilerChoicePropertyRegistryName)Version"
                    Value="$(@compiler_id@Version)"/>
            </RegistryKey>
        </Component>
        <Component Id="@compiler_id@HostArchRegistry" Guid="$(@compiler_id@HostArchRegistryGuid)">
            <RegistryKey
                ForceDeleteOnUninstall="yes"
                Root="$(MinpackBuilderRegistryRoot)"
                Key="$(MinpackBuilderRegistryKey)">
                <RegistryValue Type="string"
                    Name="$(ActiveCompilerChoicePropertyRegistryName)HostArch"
                    Value="$(@compiler_id@HostArch)"/>
            </RegistryKey>
        </Component>
        <Component Id="@compiler_id@InstallDirRegistry" Guid="$(@compiler_id@InstallDirRegistryGuid)">
            <RegistryKey
                ForceDeleteOnUninstall="yes"
                Root="$(MinpackBuilderRegistryRoot)"
                Key="$(MinpackBuilderRegistryKey)">
                <RegistryValue Type="string"
                    Name="$(ActiveCompilerChoicePropertyRegistryName)InstallDir"
                    Value="[@compiler_id@InstallDir]"/>
            </RegistryKey>
        </Component>
        
        <ComponentGroup Id="@compiler_id@ChoicePropertyComponentGroup">
            <ComponentRef Id="@compiler_id@ChoicePropertyRegistry"/>
            <ComponentRef Id="@compiler_id@ListOfInstalledCompilersRegistry"/>
            <ComponentRef Id="@compiler_id@NumberOfInstalledCompilersRegistry"/>
            <ComponentRef Id="@compiler_id@NameRegistry"/>
            <ComponentRef Id="@compiler_id@VersionRegistry"/>
            <ComponentRef Id="@compiler_id@HostArchRegistry"/>
            <ComponentRef Id="@compiler_id@InstallDirRegistry"/>
        </ComponentGroup>
        <!-- end of test -->
        
        
        <!-- Custom actions to read the property from / save the property to registry -->
        <CustomAction 
            Id="SaveChoice.@compiler_id@"
            Property="CMDLINE_$(@compiler_id@ChoiceProperty)"
            Value="[$(@compiler_id@ChoiceProperty)]"
            Execute="firstSequence"/>
        <CustomAction 
            Id="SetChoice.@compiler_id@.FromCmdLine"
            Property="$(@compiler_id@ChoiceProperty)"
            Value="[CMDLINE_$(@compiler_id@ChoiceProperty)]" 
            Execute="firstSequence"/>
        <InstallUISequence>
            <Custom Action="SaveChoice.@compiler_id@" Before="AppSearch"/>
            <Custom Action="SetChoice.@compiler_id@.FromCmdLine" After="AppSearch" Condition="CMDLINE_$(@compiler_id@ChoiceProperty)"/>
        </InstallUISequence>
        <InstallExecuteSequence>
            <Custom Action="SaveChoice.@compiler_id@" Before="AppSearch"/>
            <Custom Action="SetChoice.@compiler_id@.FromCmdLine" After="AppSearch" Condition="CMDLINE_$(@compiler_id@ChoiceProperty)"/>
        </InstallExecuteSequence>
        
        <!-- Define a feature to store the property value on registry -->
        <Feature Id="@compiler_id@ChoiceOnReg" Title="Save on registry the choice for compiler $(@compiler_id@DisplayText)" Level="1">
            <!-- <ComponentRef Id="@compiler_id@ChoicePropertyRegistry"/> -->
            <ComponentGroupRef Id="@compiler_id@ChoicePropertyComponentGroup"/>
        </Feature>
        
    </Fragment>
</Wix>
